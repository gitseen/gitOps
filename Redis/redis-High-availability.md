Redis的性能瓶颈在于内存和网络IO上，针对内存上的性能瓶颈，Redis总共采用了三种技术方案，分别是增加内存、内存淘汰策略以及集群。集群不仅解决了内存瓶颈还是提供了高可用和分布式性能。  
Redis高可用方案从演变的过程大致分为三种，分别是主从复制模式，哨兵模式、集群模式。  

众所周知，单机模式下，如果Redis服务器出现故障，内存中的数据将不复存在，而对应的客户端请求都将打到数据库服务器上，当访问量非常大的情况下，数据库服务器是会崩的。虽然Redis服务恢复了正常，可以通过RDB和AFO从磁盘中恢复数据，但是如果磁盘出现了故障，数据仍旧是不可用的，并且，在单机模式下，读写是不分离的，大量的请求也会出现IO性能瓶颈。  

如果同一个数据服务器部署到多台机器上，当一台机器宕机，只要有一个机器仍旧可用就不会影响正常使用。这也正是Redis最初想到的高可用性能方案之一主从复制模式。  

# 一、主从复制模式
主从复制模式就是让一个服务器去复制另一个服务器。我们称被复制的服务器叫主服务器，而对主服务器进行复制的服务器叫从服务器。 
[IMG](https://p3-sign.toutiaoimg.com/tos-cn-i-qvj2lq49k0/d834c8a5d6a940338cf80055805af7a7~noop.image?_iz=58558&from=article.pc_detail&x-expires=1676443807&x-signature=0a07nJFYIOcJTzc9Fvjyo79dSeA%3D)  

Redis的复制功能分为两个部分：同步和命令传播两个操作。当客户端向从服务器发送异步SLAVEOF命令，就意味着让从服务器复制一个主服务器。  
+ 同步，在Redis2.8版本开始使用了PSYNC命令替代了2.8版本之前的SYNC命令，用来执行复制时的同步操作。PSYNC的命令具有完整重同步和部分重同步两种模式。而SYNC仅支持完整重同步。
+ 命令传播，在执行同步完成之后，主从服务器两者的数据达到一致的状态，此时主服务器只需要将自己执行的写命令发送给从服务器，而从服务器只需要一直执行主服务器发来的写命令就可以保证主从服务器的一致性了。

**注意：心跳检测，在命令传播阶段，从服务器默认会以每秒一次的频率，向主服务器发送命令REPLCONF ACK 偏移量 。主要有三个作用，分别是检测网络连接状态、辅助实现min-slaves选项、检测命令丢失。主要是为了保证数据能够安全同步到从服务器并且保证数据状态一致不丢失。**  
   - 完整重同步：它适用于初次复制情况，主要是通过让主服务器创建并发送RDB文件，以及向从服务器发送保存在缓冲区里面的写命令来进行同步。（缓冲区，是因为在发送RDB的同时，有新的写命令过来，而不在RDB文件中的那一部分命令）
   - 部分重同步：它适用于断线后的重复制情况，当服务器断线后重新连接了主服务器。如果条件允许，主服务器可以将主服务器连接断开期间所执行的写命令发送给从服务器。从服务器只需要接收并执行这些命令即可，就可以将数据库更新至主服务器当前所处的状态。
## 1、PSYNC和SYNC同步有什么区别呢？
PSYNC和SYNC同步的区别主要在于，PSYNC支持部分重同步，而SYNC的每次同步都是由主服务器全量的创建并传递RDB文件给从服务器，非常占用网络资源和从服务器导入时的阻塞时间。  
## 2、部分重同步有什么特点呢？
+ 主服务器和从服务器分别维护一个复制偏移量
+ 标记同步的进度，偏移量相同则完全同步，偏移量不相同则数据未处于一致状态。
+ 主服务器的复制积压缓冲区
  - 1）主服务器的复制积压缓冲区里面会保存一部分最近传播的写命令，并且复制积压缓冲区会为队列中的每个字节记录相应的复制偏移量。
  - 2）通过偏移量，可以得知从服务器所丢失的数据是否在积压缓冲区中，如果存在则进行部分重同步，如果不存在则进行完整重同步。
+ 服务器的运行ID
  - 1）从服务器初次复制主服务器数据时，主服务器会将自己的运行ID传递给从服务器，而从服务器会存储起来。
  - 2）如果从服务器断电后，重新连接上一个主服务器，它会将之前存储的运行ID传递过去。
  - 3）如果发送的运行ID和当前连接的服务器运行ID相同，则主服务器可以执行部分重同步操作。否则进行完整重同步操作。
## 3、主从模式的优缺点
* 优点：支持读写分离，数据备份，提高效率。
* 缺点：不支持自动容错和恢复功能，主节点故障，集群无法正常工作，从节点升级为主节点需要人工干预。
